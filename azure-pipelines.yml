trigger:
  branches:
    include:
      - dev
      - stage
      - master
  batch: true

pool:
  name: Default

variables:
  buildConfiguration: "Release"

stages:
  # -------------------------
  # BUILD (runs for all branches)
  # -------------------------
  - stage: Build
    displayName: Build and Test
    jobs:
      - job: BuildJob
        steps:
          - task: NuGetToolInstaller@1

          - task: NuGetCommand@2
            inputs:
              restoreSolution: "**/*.sln"
              feedsToUse: "config"
              nugetConfigPath: "nuget.config"

          - task: VSBuild@1
            inputs:
              solution: "**/*.sln"
              configuration: "$(buildConfiguration)"

          - script: dotnet test --configuration $(buildConfiguration)
            displayName: Run tests

          - task: PublishBuildArtifacts@1
            inputs:
              pathtoPublish: "$(Build.ArtifactStagingDirectory)"
              artifactName: "drop"
              publishLocation: "Container"

  # -------------------------
  # DEPLOY TO DEV (only dev branch)
  # -------------------------
  - stage: Deploy_Dev
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))
    jobs:
      - deployment: DevDeploy
        environment: "dev"
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to DEV"

  # -------------------------
  # DEPLOY TO STAGE (only stage branch)
  # -------------------------
  - stage: Deploy_Stage
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/stage'))
    jobs:
      - deployment: StageDeploy
        environment: "stage"
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to STAGE"

  # -------------------------
  # DEPLOY TO PROD (only master branch)
  # -------------------------
  - stage: Deploy_Prod
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    jobs:
      - deployment: ProdDeploy
        environment: "prod"
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploying to PROD"
